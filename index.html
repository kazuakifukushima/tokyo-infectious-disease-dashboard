<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>東京都感染症ダッシュボード - デモ版</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
            color: #374151;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .sidebar-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }
        
        .nav-item {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .nav-item:hover {
            background-color: #f3f4f6;
        }
        
        .nav-item.active {
            background-color: #dbeafe;
            border-right: 3px solid #3b82f6;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: white;
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .header-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        
        .header-subtitle {
            color: #6b7280;
        }
        
        .content {
            flex: 1;
            padding: 2rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
        }
        
        .chart-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1f2937;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 300px;
            color: #6b7280;
        }
        
        .error {
            color: #dc2626;
            text-align: center;
            padding: 2rem;
        }
        
        .disease-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
        }
        
        .disease-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
        }
        
        .disease-item:last-child {
            border-bottom: none;
        }
        
        .disease-name {
            font-weight: 500;
        }
        
        .disease-count {
            color: #6b7280;
            font-family: monospace;
        }
        
        .filter-section {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        
        .form-select {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background-color: white;
            font-size: 0.875rem;
        }
        
        .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2563eb;
        }
        
        .btn-primary:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .data-table th,
        .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .data-table th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
        }
        
        .data-table tr:hover {
            background-color: #f9fafb;
        }
        
        .metric-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .metric-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .metric-value {
            font-size: 1.875rem;
            font-weight: 700;
            color: #3b82f6;
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">🏥 IDSC Dashboard</div>
                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">感染症データ分析</div>
            </div>
            <nav>
                <div style="padding: 0.5rem 1.5rem; font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em;">全数把握疾患</div>
                <div class="nav-item active" data-view="overview">📊 概況</div>
                <div class="nav-item" data-view="diseases">🦠 疾病別分析</div>
                <div class="nav-item" data-view="categories">📋 分類別統計</div>
                <div class="nav-item" data-view="trends">📈 時系列分析</div>
                
                <div style="padding: 0.5rem 1.5rem; font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 1rem; border-top: 1px solid #e5e7eb;">定点サーベイランス</div>
                <div class="nav-item" data-view="sentinel-overview">🏥 定点概況</div>
                <div class="nav-item" data-view="sentinel-diseases">🦠 定点疾病分析</div>
                <div class="nav-item" data-view="sentinel-geographic">🗺️ 地域別分析</div>
            </nav>
        </div>
        
        <div class="main-content">
            <div class="header">
                <div class="header-title">東京都感染症ダッシュボード</div>
                <div class="header-subtitle" id="data-period">データ期間: 2000年 ～ 2025年</div>
            </div>
            
            <div class="content" id="main-content">
                <div class="loading">データを読み込み中...</div>
            </div>
        </div>
    </div>

    <script>
        let summaryData = null;
        let currentView = 'overview';
        let diseaseList = [];
        let currentDiseaseData = null;
        let isSeasonalMode = false;
        let seasonalData = null;
        let mainDataset = null; // 全データを保持
        let sentinelDataset = null; // 定点サーベイランスデータ
        let sentinelSummaryData = null;
        let sentinelDiseaseList = [];
        let sentinelCurrentData = null; // 現在分析中のデータ
        let sentinelIsSeasonalMode = false; // 季節性比較モード
        let sentinelSeasonalData = null; // 季節性比較データ

        // 静的データ読み込みクライアント
        async function fetchStaticData(filename) {
            try {
                // キャッシュを無効化するためのタイムスタンプを追加
                const cacheBuster = new Date().getTime();
                const response = await fetch(`./data/${filename}?v=${cacheBuster}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                if (filename.endsWith('.json')) {
                    return await response.json();
                } else {
                    return await response.text();
                }
            } catch (error) {
                console.error('Data Loading Error:', error);
                throw error;
            }
        }

        // CSVをパースする関数
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',');
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const row = {};
                headers.forEach((header, index) => {
                    const value = values[index]?.trim() || '';
                    // 数値フィールドの変換
                    if (header === 'count' || header === 'year' || header === 'week' || 
                        header === 'male_count' || header === 'female_count' || 
                        header === 'total_count' || header === 'sentinel_points') {
                        row[header] = parseInt(value) || 0;
                    } else {
                        row[header] = value;
                    }
                });
                data.push(row);
            }
            
            return data;
        }

        // 静的データの初期化
        async function initializeStaticData() {
            try {
                // 各データファイルを並行で読み込み
                const [summaryText, diseaseListData, csvText] = await Promise.all([
                    fetchStaticData('summary_statistics.json'),
                    fetchStaticData('disease_list.json'),
                    fetchStaticData('infectious_diseases_data.csv')
                ]);
                
                summaryData = summaryText;
                diseaseList = diseaseListData;
                mainDataset = parseCSV(csvText);
                
                console.log(`データ初期化完了: ${mainDataset.length} レコード, ${diseaseList.length} 疾病`);
                
            } catch (error) {
                console.error('データ初期化エラー:', error);
                throw error;
            }
        }

        // Sentinelデータの初期化
        async function initializeSentinelData() {
            try {
                // Sentinelデータファイルを並行で読み込み
                const [sentinelSummaryText, sentinelDiseaseListData, sentinelCsvText] = await Promise.all([
                    fetchStaticData('sentinel_summary_statistics.json'),
                    fetchStaticData('sentinel_disease_list.json'),
                    fetchStaticData('sentinel_diseases_data.csv')
                ]);
                
                sentinelSummaryData = sentinelSummaryText;
                sentinelDiseaseList = sentinelDiseaseListData;
                sentinelDataset = parseCSV(sentinelCsvText);
                
                console.log(`Sentinelデータ初期化完了: ${sentinelDataset.length} レコード, ${sentinelDiseaseList.length} 疾病`);
                
            } catch (error) {
                console.error('Sentinelデータ初期化エラー:', error);
                throw error;
            }
        }

        // 静的データ用のAPI互換関数
        async function fetchAPI(endpoint) {
            // データが未初期化の場合は初期化
            if (!mainDataset) {
                await initializeStaticData();
            }
            
            try {
                // エンドポイントに応じて静的データから生成
                if (endpoint === '/summary') {
                    return summaryData;
                    
                } else if (endpoint === '/diseases') {
                    return { diseases: diseaseList };
                    
                } else if (endpoint.startsWith('/diseases/') && endpoint.includes('/timeseries')) {
                    return generateTimeSeriesData(endpoint);
                    
                } else if (endpoint.startsWith('/diseases/top')) {
                    return generateTopDiseasesData(endpoint);
                    
                } else if (endpoint === '/yearly-trends') {
                    return generateYearlyTrendsData();
                    
                } else {
                    throw new Error(`Unknown endpoint: ${endpoint}`);
                }
            } catch (error) {
                console.error('Static API Error:', error);
                throw error;
            }
        }

        // 疾病別時系列データ生成
        function generateTimeSeriesData(endpoint) {
            const match = endpoint.match(/\/diseases\/([^\/]+)\/timeseries/);
            if (!match) throw new Error('Invalid timeseries endpoint');
            
            const diseaseNameEncoded = match[1];
            const diseaseName = decodeURIComponent(diseaseNameEncoded);
            
            // URLパラメータの解析
            const url = new URL(window.location.origin + endpoint);
            const startYear = url.searchParams.get('start_year');
            const endYear = url.searchParams.get('end_year');
            
            // 疾病名とフィルタ条件でデータを抽出
            let filteredData = mainDataset.filter(record => record.disease_name === diseaseName);
            
            // 年範囲でフィルタリング
            if (startYear) {
                filteredData = filteredData.filter(record => record.year >= parseInt(startYear));
            }
            if (endYear) {
                filteredData = filteredData.filter(record => record.year <= parseInt(endYear));
            }
            
            // 日付でソート
            filteredData.sort((a, b) => a.report_date.localeCompare(b.report_date));
            
            // API形式に変換
            const timeseriesData = filteredData.map(record => ({
                date: record.report_date,
                value: record.count
            }));
            
            return {
                disease_name: diseaseName,
                data: timeseriesData,
                total_records: timeseriesData.length
            };
        }

        // 上位疾病データ生成
        function generateTopDiseasesData(endpoint) {
            const url = new URL(window.location.origin + endpoint);
            const limit = parseInt(url.searchParams.get('limit')) || 10;
            const year = url.searchParams.get('year');
            
            let data = mainDataset;
            if (year) {
                data = data.filter(record => record.year === parseInt(year));
            }
            
            // 疾病別合計を計算
            const diseaseStats = {};
            data.forEach(record => {
                if (!diseaseStats[record.disease_name]) {
                    diseaseStats[record.disease_name] = {
                        total_count: 0,
                        category: record.category
                    };
                }
                diseaseStats[record.disease_name].total_count += record.count;
            });
            
            // 上位疾病を取得
            const sortedDiseases = Object.entries(diseaseStats)
                .sort(([,a], [,b]) => b.total_count - a.total_count)
                .slice(0, limit)
                .map(([disease, stats]) => ({
                    disease_name: disease,
                    total_count: stats.total_count,
                    category: stats.category
                }));
            
            return {
                top_diseases: sortedDiseases,
                year: year ? parseInt(year) : null,
                total_diseases: sortedDiseases.length
            };
        }

        // 年次推移データ生成
        function generateYearlyTrendsData() {
            const yearlyTotals = {};
            
            mainDataset.forEach(record => {
                if (!yearlyTotals[record.year]) {
                    yearlyTotals[record.year] = 0;
                }
                yearlyTotals[record.year] += record.count;
            });
            
            const trends = Object.entries(yearlyTotals)
                .sort(([a], [b]) => parseInt(a) - parseInt(b))
                .map(([year, total]) => ({
                    year: parseInt(year),
                    total_count: total
                }));
            
            return { yearly_trends: trends };
        }

        // 概況ビューのレンダリング
        async function renderOverview() {
            const content = document.getElementById('main-content');
            
            try {
                // サマリーデータとトップ疾病を並行取得
                const [summary, topDiseases, yearlyTrends] = await Promise.all([
                    fetchAPI('/summary'),
                    fetchAPI('/diseases/top?limit=10'),
                    fetchAPI('/yearly-trends')
                ]);

                summaryData = summary;

                content.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">総レコード数</div>
                            <div class="stat-value">${summary.total_records.toLocaleString()}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">感染症種類</div>
                            <div class="stat-value">${summary.total_diseases}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">対象年数</div>
                            <div class="stat-value">${summary.years_covered.length}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">法定分類数</div>
                            <div class="stat-value">${Object.keys(summary.disease_categories).length}</div>
                        </div>
                    </div>
                    
                    <div class="charts-grid">
                        <div class="chart-card">
                            <div class="chart-title">報告数上位感染症</div>
                            <div class="chart-container">
                                <canvas id="topDiseasesChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <div class="chart-title">年次推移</div>
                            <div class="chart-container">
                                <canvas id="yearlyTrendsChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <div class="chart-title">法定分類別分布</div>
                            <div class="chart-container">
                                <canvas id="categoriesChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <div class="chart-title">主要疾病一覧</div>
                            <div class="disease-list">
                                ${topDiseases.top_diseases.map(disease => `
                                    <div class="disease-item">
                                        <span class="disease-name">${disease.disease_name}</span>
                                        <span class="disease-count">${disease.total_count.toLocaleString()}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;

                // チャートの描画
                renderTopDiseasesChart(topDiseases.top_diseases);
                renderYearlyTrendsChart(yearlyTrends.yearly_trends);
                renderCategoriesChart(summary.disease_categories);

            } catch (error) {
                content.innerHTML = `<div class="error">データの読み込みに失敗しました: ${error.message}</div>`;
            }
        }

        // チャート描画関数
        function renderTopDiseasesChart(data) {
            const ctx = document.getElementById('topDiseasesChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.disease_name.length > 10 ? d.disease_name.substring(0, 10) + '...' : d.disease_name),
                    datasets: [{
                        label: '報告数',
                        data: data.map(d => d.total_count),
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderYearlyTrendsChart(data) {
            const ctx = document.getElementById('yearlyTrendsChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.year.toString()),
                    datasets: [{
                        label: '年間総報告数',
                        data: data.map(d => d.total_count),
                        borderColor: 'rgba(34, 197, 94, 1)',
                        backgroundColor: 'rgba(34, 197, 94, 0.2)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderCategoriesChart(data) {
            const ctx = document.getElementById('categoriesChart').getContext('2d');
            const colors = [
                'rgba(239, 68, 68, 0.8)',
                'rgba(245, 158, 11, 0.8)',
                'rgba(34, 197, 94, 0.8)',
                'rgba(59, 130, 246, 0.8)',
                'rgba(147, 51, 234, 0.8)',
                'rgba(156, 163, 175, 0.8)'
            ];
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: colors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // 疾病を分類別にグループ化
        function groupDiseasesByCategory(diseases, summaryData) {
            // 分類別疾病マップを作成
            const categoryMap = {
                "1類感染症": [
                    "エボラ出血熱", "クリミア・コンゴ出血熱", "痘そう", "南米出血熱", 
                    "ペスト", "マールブルグ病", "ラッサ熱"
                ],
                "2類感染症": [
                    "急性灰白髄炎", "結核", "ジフテリア", "重症急性呼吸器症候群", 
                    "中東呼吸器症候群", "鳥インフルエンザ（H5N1)", "鳥インフルエンザ（H7N9)",
                    "鳥インフルエンザ（H5N1およびH7N9を除く）"
                ],
                "3類感染症": [
                    "コレラ", "細菌性赤痢", "腸チフス", "パラチフス"
                ],
                "4類感染症": [
                    "A型肝炎", "E型肝炎", "つつが虫病", "ウイルス性肝炎（Ｅ型肝炎及びＡ型肝炎を除く。）",
                    "ウエストナイル熱", "エキノコックス症", "オウム病", "オムスク出血熱",
                    "回帰熱", "Ｑ熱", "狂犬病", "コクシジオイデス症", "ジカウイルス感染症",
                    "重症熱性血小板減少症候群", "腎症候性出血熱", "西部ウマ脳炎", "ダニ媒介脳炎",
                    "炭疽", "チクングニア熱", "デング熱", "東部ウマ脳炎",
                    "ニパウイルス感染症", "日本紅斑熱", "日本脳炎", "ハンタウイルス肺症候群", 
                    "Ｂウイルス病", "鼻疽", "ブルセラ症", "ベネズエラウマ脳炎", "ヘンドラウイルス感染症", 
                    "発しんチフス", "ボツリヌス症", "マラリア", "野兎病", "ライム病", 
                    "リッサウイルス感染症", "リフトバレー熱", "類鼻疽", "レジオネラ症", 
                    "レプトスピラ症", "ロッキー山紅斑熱", "黄熱"
                ],
                "5類感染症": [
                    "アメーバ赤痢", "カルバペネム耐性腸内細菌目細菌感染症", 
                    "急性弛緩性麻痺（急性灰白髄炎を除く。）", "急性脳炎", "クリプトスポリジウム症", 
                    "クロイツフェルト・ヤコブ病", "劇症型溶血性レンサ球菌感染症", "後天性免疫不全症候群", 
                    "ジアルジア症", "侵襲性インフルエンザ菌感染症", "侵襲性肺炎球菌感染症", 
                    "侵襲性髄膜炎菌感染症", "水痘（入院例に限る）", "先天性風しん症候群", "梅毒", 
                    "播種性クリプトコックス症", "バンコマイシン耐性腸球菌感染症", 
                    "バンコマイシン耐性黄色ブドウ球菌感染症", "百日咳", "風しん", "麻しん", 
                    "薬剤耐性アシネトバクター感染症", "腸管出血性大腸菌感染症", "髄膜炎菌性髄膜炎"
                ]
            };

            // 疾病を分類別にグループ化
            const groupedDiseases = {};
            const uncategorized = [];

            // 分類別に疾病を振り分け
            Object.keys(categoryMap).forEach(category => {
                groupedDiseases[category] = [];
                categoryMap[category].forEach(disease => {
                    if (diseases.includes(disease)) {
                        groupedDiseases[category].push(disease);
                    }
                });
                // アルファベット順にソート
                groupedDiseases[category].sort();
            });

            // 分類に該当しない疾病を特定
            diseases.forEach(disease => {
                let found = false;
                Object.values(categoryMap).forEach(categoryDiseases => {
                    if (categoryDiseases.includes(disease)) {
                        found = true;
                    }
                });
                if (!found) {
                    uncategorized.push(disease);
                }
            });

            if (uncategorized.length > 0) {
                groupedDiseases["その他"] = uncategorized.sort();
            }

            return groupedDiseases;
        }

        // セレクトボックスのオプションを生成
        function generateDiseaseOptions(groupedDiseases, summaryData) {
            let options = '<option value="">感染症を選択してください</option>';
            
            Object.entries(groupedDiseases).forEach(([category, diseases]) => {
                if (diseases.length > 0) {
                    // 分類の報告数を取得
                    const categoryCount = summaryData?.disease_categories?.[category] || 0;
                    options += `<optgroup label="${category} (${categoryCount.toLocaleString()}件)">`;
                    
                    diseases.forEach(disease => {
                        // 個別疾病の報告数を取得
                        const diseaseCount = summaryData?.top_diseases?.[disease] || 0;
                        const countDisplay = diseaseCount > 0 ? ` (${diseaseCount.toLocaleString()}件)` : '';
                        options += `<option value="${disease}">${disease}${countDisplay}</option>`;
                    });
                    
                    options += '</optgroup>';
                }
            });
            
            return options;
        }

        // 疾病別分析ビューのレンダリング
        async function renderDiseaseAnalysis() {
            const content = document.getElementById('main-content');
            
            try {
                // 疾病リストとサマリーデータを取得
                if (diseaseList.length === 0) {
                    const diseaseData = await fetchAPI('/diseases');
                    diseaseList = diseaseData.diseases;
                }

                // 疾病を分類別にグループ化
                const groupedDiseases = groupDiseasesByCategory(diseaseList, summaryData);
                const diseaseOptions = generateDiseaseOptions(groupedDiseases, summaryData);

                content.innerHTML = `
                    <div class="filter-section">
                        <h3 class="chart-title">分析対象設定</h3>
                        <div class="filter-grid">
                            <div class="form-group">
                                <label class="form-label">感染症名（法定分類別）</label>
                                <select id="diseaseSelect" class="form-select">
                                    ${diseaseOptions}
                                </select>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                                    ※括弧内は全期間の報告数
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">開始年</label>
                                <select id="startYear" class="form-select">
                                    ${Array.from({length: 26}, (_, i) => 2000 + i).map(year => `
                                        <option value="${year}" ${year === 2020 ? 'selected' : ''}>${year}年</option>
                                    `).join('')}
                                </select>
                                <div style="font-size: 0.75rem; color: transparent; margin-top: 0.25rem;">
                                    　
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">終了年</label>
                                <select id="endYear" class="form-select">
                                    ${Array.from({length: 26}, (_, i) => 2000 + i).map(year => `
                                        <option value="${year}" ${year === 2024 ? 'selected' : ''}>${year}年</option>
                                    `).join('')}
                                </select>
                                <div style="font-size: 0.75rem; color: transparent; margin-top: 0.25rem;">
                                    　
                                </div>
                            </div>
                            <div class="form-group">
                                <button id="analyzeBtn" class="btn btn-primary" disabled>分析実行</button>
                                <div style="font-size: 0.75rem; color: transparent; margin-top: 0.25rem;">
                                    　
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="analysisResults" style="display: none;">
                        <div class="metric-cards">
                            <div class="metric-card">
                                <div class="metric-value" id="totalRecords">-</div>
                                <div class="metric-label">データポイント数</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="totalCases">-</div>
                                <div class="metric-label">期間内総報告数</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="maxWeekly">-</div>
                                <div class="metric-label">最大週間報告数</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="avgWeekly">-</div>
                                <div class="metric-label">週平均報告数</div>
                            </div>
                        </div>
                        
                        <div class="charts-grid">
                            <div class="chart-card" style="grid-column: 1 / -1;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <div class="chart-title" id="timeseriesTitle">時系列グラフ</div>
                                    <div style="display: flex; gap: 1rem; align-items: center;">
                                        <div class="form-group" style="margin: 0;">
                                            <button id="seasonalToggleBtn" class="btn btn-primary" style="font-size: 0.875rem; padding: 0.375rem 0.75rem;">
                                                季節性比較
                                            </button>
                                        </div>
                                        <div class="form-group" style="margin: 0;">
                                            <select id="timeUnitSelect" class="form-select" style="min-width: 120px;">
                                                <option value="week">週単位</option>
                                                <option value="month">月単位</option>
                                                <option value="year">年単位</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="chart-container" style="height: 400px;">
                                    <canvas id="timeseriesChart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <div class="chart-title">データ詳細 (最新20件)</div>
                            <div style="max-height: 400px; overflow-y: auto;">
                                <table class="data-table" id="dataTable">
                                    <thead>
                                        <tr>
                                            <th>報告日</th>
                                            <th>報告数</th>
                                            <th>年</th>
                                            <th>週</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dataTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;

                // イベントリスナーを追加
                setupDiseaseAnalysisEvents();

            } catch (error) {
                content.innerHTML = `<div class="error">疾病別分析の読み込みに失敗しました: ${error.message}</div>`;
            }
        }

        // 疾病別分析のイベントハンドラー
        function setupDiseaseAnalysisEvents() {
            const diseaseSelect = document.getElementById('diseaseSelect');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const timeUnitSelect = document.getElementById('timeUnitSelect');
            const seasonalToggleBtn = document.getElementById('seasonalToggleBtn');

            diseaseSelect.addEventListener('change', function() {
                analyzeBtn.disabled = !this.value;
                // 疾病が変更されたら季節性モードをリセット
                isSeasonalMode = false;
                seasonalData = null;
                updateSeasonalToggleButton();
            });

            // 時間単位変更時のイベントリスナー
            timeUnitSelect.addEventListener('change', function() {
                if (currentDiseaseData && !isSeasonalMode) {
                    const disease = diseaseSelect.value;
                    renderDiseaseTimeseries(currentDiseaseData, disease);
                }
            });

            // 季節性比較ボタンのイベントリスナー
            seasonalToggleBtn.addEventListener('click', function() {
                toggleSeasonalMode();
            });

            analyzeBtn.addEventListener('click', async function() {
                const disease = diseaseSelect.value;
                const startYear = document.getElementById('startYear').value;
                const endYear = document.getElementById('endYear').value;

                if (!disease) return;

                this.disabled = true;
                this.textContent = '分析中...';

                try {
                    await analyzeDiseaseData(disease, startYear, endYear);
                } catch (error) {
                    alert('分析中にエラーが発生しました: ' + error.message);
                } finally {
                    this.disabled = false;
                    this.textContent = '分析実行';
                }
            });
        }

        // 疾病データの分析実行
        async function analyzeDiseaseData(disease, startYear, endYear) {
            try {
                // 開始年と終了年が同じ場合は季節性比較モード
                const isSameYear = parseInt(startYear) === parseInt(endYear);
                
                if (isSameYear) {
                    await analyzeSeasonalPattern(disease, startYear);
                } else {
                    const data = await fetchAPI(`/diseases/${encodeURIComponent(disease)}/timeseries?start_year=${startYear}&end_year=${endYear}`);
                    currentDiseaseData = data;

                    // 統計情報を計算
                    const totalCases = data.data.reduce((sum, item) => sum + item.value, 0);
                    const maxWeekly = Math.max(...data.data.map(item => item.value));
                    const avgWeekly = totalCases / data.data.length;

                    // メトリクスカードを更新
                    document.getElementById('totalRecords').textContent = data.total_records.toLocaleString();
                    document.getElementById('totalCases').textContent = totalCases.toLocaleString();
                    document.getElementById('maxWeekly').textContent = maxWeekly.toLocaleString();
                    document.getElementById('avgWeekly').textContent = avgWeekly.toFixed(1);

                    // チャートを描画
                    renderDiseaseTimeseries(data, disease);

                    // データテーブルを更新
                    updateDataTable(data.data);
                }

                // 結果セクションを表示
                document.getElementById('analysisResults').style.display = 'block';

            } catch (error) {
                throw new Error(`データの取得に失敗しました: ${error.message}`);
            }
        }

        // 季節性パターン分析
        async function analyzeSeasonalPattern(disease, targetYear) {
            try {
                // 全データを取得して複数年のデータを準備
                const allData = await fetchAPI(`/diseases/${encodeURIComponent(disease)}/timeseries?start_year=2000&end_year=2025`);
                
                // 対象年を含む過去5年分のデータを取得
                const years = [];
                const currentYear = parseInt(targetYear);
                for (let i = 4; i >= 0; i--) {
                    const year = currentYear - i;
                    if (year >= 2000) {
                        years.push(year);
                    }
                }
                
                // 年別にデータを分離
                const yearlyData = {};
                years.forEach(year => {
                    yearlyData[year] = allData.data.filter(item => {
                        const itemYear = new Date(item.date).getFullYear();
                        return itemYear === year;
                    });
                });
                
                // 週番号でデータを正規化（52週として扱う）
                const normalizedData = {};
                years.forEach(year => {
                    normalizedData[year] = [];
                    for (let week = 1; week <= 52; week++) {
                        const weekData = yearlyData[year].filter(item => {
                            const date = new Date(item.date);
                            const weekNum = getWeekNumber(date);
                            return weekNum === week;
                        });
                        
                        const totalValue = weekData.reduce((sum, item) => sum + item.value, 0);
                        normalizedData[year].push({
                            week: week,
                            value: totalValue,
                            date: `${year}-W${String(week).padStart(2, '0')}`
                        });
                    }
                });
                
                // 統計情報を計算（対象年のデータ）
                const targetYearData = normalizedData[currentYear] || [];
                const totalCases = targetYearData.reduce((sum, item) => sum + item.value, 0);
                const maxWeekly = Math.max(...targetYearData.map(item => item.value));
                const avgWeekly = totalCases / 52;
                
                // メトリクスカードを更新
                document.getElementById('totalRecords').textContent = targetYearData.length.toLocaleString();
                document.getElementById('totalCases').textContent = totalCases.toLocaleString();
                document.getElementById('maxWeekly').textContent = maxWeekly.toLocaleString();
                document.getElementById('avgWeekly').textContent = avgWeekly.toFixed(1);
                
                // 季節性データを保存
                seasonalData = {
                    normalizedData: normalizedData,
                    disease: disease,
                    years: years,
                    targetYear: currentYear,
                    yearlyData: yearlyData
                };
                
                // 季節性モードフラグを設定
                isSeasonalMode = true;
                updateSeasonalToggleButton();
                
                // 季節性比較チャートを描画
                renderSeasonalComparisonChart(normalizedData, disease, years, currentYear);
                
                // データテーブルを更新（対象年のデータ）
                updateDataTable(yearlyData[currentYear] || []);
                
                // currentDiseaseDataを設定（時間単位変更に対応）
                currentDiseaseData = {
                    disease_name: disease,
                    data: yearlyData[currentYear] || [],
                    total_records: targetYearData.length
                };
                
            } catch (error) {
                throw new Error(`季節性パターン分析に失敗しました: ${error.message}`);
            }
        }
        
        // 週番号を取得する関数
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }
        
        // 季節性比較チャートの描画
        function renderSeasonalComparisonChart(normalizedData, diseaseName, years, targetYear) {
            const ctx = document.getElementById('timeseriesChart');
            
            // 既存のチャートを破棄
            if (window.diseaseChart) {
                window.diseaseChart.destroy();
            }
            
            // タイトルを更新
            document.getElementById('timeseriesTitle').textContent = `${diseaseName} の季節性パターン比較（${targetYear}年と過去4年）`;
            
            // 年毎の色分け配列（過去年用）
            const pastYearColors = [
                'rgba(59, 130, 246, 0.8)',  // 青
                'rgba(34, 197, 94, 0.8)',   // 緑
                'rgba(245, 158, 11, 0.8)',  // オレンジ
                'rgba(147, 51, 234, 0.8)',  // 紫
                'rgba(236, 72, 153, 0.8)'   // ピンク
            ];
            
            // 対象年用の色（独立）
            const targetYearColor = 'rgba(239, 68, 68, 1)';  // 赤
            const targetYearBg = 'rgba(239, 68, 68, 0.1)';
            
            // データセットを作成（対象年を最初に、その後新しい年から古い年の順）
            const datasets = [];
            
            // 対象年のデータセットを最初に追加
            datasets.push({
                label: `${targetYear}年 (対象年)`,
                data: normalizedData[targetYear] ? normalizedData[targetYear].map(item => item.value) : new Array(52).fill(0),
                borderColor: targetYearColor,
                backgroundColor: targetYearBg,
                tension: 0.1,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 7,
                borderWidth: 4,
                order: 0  // 最前面に表示
            });
            
            // 過去年のデータセットを新しい年から古い年の順で追加
            const pastYears = years.filter(year => year !== targetYear).sort((a, b) => b - a); // 降順ソート
            pastYears.forEach((year, index) => {
                datasets.push({
                    label: `${year}年`,
                    data: normalizedData[year] ? normalizedData[year].map(item => item.value) : new Array(52).fill(0),
                    borderColor: pastYearColors[index % pastYearColors.length],
                    backgroundColor: 'transparent',
                    tension: 0.1,
                    fill: false,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    borderWidth: 3,
                    order: index + 1
                });
            });
            
            // 週ラベルを作成
            const weekLabels = [];
            for (let week = 1; week <= 52; week++) {
                if (week % 4 === 1 || week === 1) {
                    weekLabels.push(`第${week}週`);
                } else {
                    weekLabels.push('');
                }
            }
            
            window.diseaseChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weekLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                filter: function(legendItem, chartData) {
                                    // 対象年を最初に表示
                                    return true;
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const weekNum = context[0].dataIndex + 1;
                                    return `第${weekNum}週`;
                                },
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y}件`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '週間報告数'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '週番号（年間）'
                            },
                            ticks: {
                                maxTicksLimit: 13  // 約4週間ごとに表示
                            }
                        }
                    }
                }
            });
        }

        // データを指定した時間単位で集約
        function aggregateDataByTimeUnit(data, timeUnit) {
            const aggregated = {};
            
            data.forEach(item => {
                const date = new Date(item.date);
                let key;
                
                switch (timeUnit) {
                    case 'week':
                        // 週単位: そのまま使用
                        key = item.date.substring(0, 10); // YYYY-MM-DD
                        break;
                    case 'month':
                        // 月単位: YYYY-MM形式
                        key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                        break;
                    case 'year':
                        // 年単位: YYYY形式
                        key = date.getFullYear().toString();
                        break;
                    default:
                        key = item.date.substring(0, 10);
                }
                
                if (!aggregated[key]) {
                    aggregated[key] = {
                        date: key,
                        value: 0
                    };
                }
                aggregated[key].value += item.value;
            });
            
            // 日付でソート
            return Object.values(aggregated).sort((a, b) => a.date.localeCompare(b.date));
        }

        // ラベルをフォーマット
        function formatLabel(dateString, timeUnit) {
            switch (timeUnit) {
                case 'week':
                    const date = new Date(dateString);
                    return date.toLocaleDateString('ja-JP', { year: 'numeric', month: 'short', day: 'numeric' });
                case 'month':
                    const [year, month] = dateString.split('-');
                    return `${year}年${parseInt(month)}月`;
                case 'year':
                    return `${dateString}年`;
                default:
                    return dateString;
            }
        }

        // 疾病時系列チャートの描画
        function renderDiseaseTimeseries(data, diseaseName) {
            const ctx = document.getElementById('timeseriesChart');
            const timeUnit = document.getElementById('timeUnitSelect').value;
            
            // 季節性モードをリセット
            isSeasonalMode = false;
            updateSeasonalToggleButton();
            
            // 既存のチャートを破棄
            if (window.diseaseChart) {
                window.diseaseChart.destroy();
            }

            // データを時間単位で集約
            const aggregatedData = aggregateDataByTimeUnit(data.data, timeUnit);

            // タイトルを更新
            const unitText = {
                'week': '週単位',
                'month': '月単位', 
                'year': '年単位'
            };
            document.getElementById('timeseriesTitle').textContent = `${diseaseName} の発生動向（${unitText[timeUnit]}）`;

            // X軸のラベル数を調整
            const maxLabels = timeUnit === 'week' ? 20 : timeUnit === 'month' ? 24 : 10;
            const stepSize = Math.max(1, Math.ceil(aggregatedData.length / maxLabels));

            window.diseaseChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: aggregatedData.map(item => formatLabel(item.date, timeUnit)),
                    datasets: [{
                        label: diseaseName,
                        data: aggregatedData.map(item => item.value),
                        borderColor: 'rgba(59, 130, 246, 1)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.1,
                        fill: true,
                        pointRadius: timeUnit === 'year' ? 4 : timeUnit === 'month' ? 3 : 2,
                        pointHoverRadius: timeUnit === 'year' ? 6 : 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '報告数'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '報告日'
                            },
                            ticks: {
                                maxTicksLimit: maxLabels,
                                callback: function(value, index) {
                                    // ラベルを間引いて表示
                                    return index % stepSize === 0 ? this.getLabelForValue(value) : '';
                                }
                            }
                        }
                    }
                }
            });
        }

        // 季節性切り替えボタンの状態を更新
        function updateSeasonalToggleButton() {
            const btn = document.getElementById('seasonalToggleBtn');
            if (btn) {
                if (isSeasonalMode) {
                    btn.textContent = '通常表示';
                    btn.style.backgroundColor = '#dc2626';
                    btn.style.borderColor = '#dc2626';
                } else {
                    btn.textContent = '季節性比較';
                    btn.style.backgroundColor = '#3b82f6';
                    btn.style.borderColor = '#3b82f6';
                }
            }
        }

        // 季節性モードの切り替え
        function toggleSeasonalMode() {
            if (!currentDiseaseData) return;
            
            const diseaseSelect = document.getElementById('diseaseSelect');
            const startYear = document.getElementById('startYear').value;
            const endYear = document.getElementById('endYear').value;
            const disease = diseaseSelect.value;
            
            if (isSeasonalMode) {
                // 通常モードに戻す
                isSeasonalMode = false;
                updateSeasonalToggleButton();
                renderDiseaseTimeseries(currentDiseaseData, disease);
            } else {
                // 季節性モードに切り替え
                if (seasonalData && seasonalData.disease === disease) {
                    // 既存の季節性データを使用
                    isSeasonalMode = true;
                    updateSeasonalToggleButton();
                    renderSeasonalComparisonChart(
                        seasonalData.normalizedData, 
                        seasonalData.disease, 
                        seasonalData.years, 
                        seasonalData.targetYear
                    );
                } else {
                    // 新しい季節性データを取得
                    const targetYear = parseInt(startYear) === parseInt(endYear) ? startYear : endYear;
                    analyzeSeasonalPattern(disease, targetYear);
                }
            }
        }

        // データテーブルの更新
        function updateDataTable(data) {
            const tbody = document.getElementById('dataTableBody');
            const recentData = data.slice(-20).reverse(); // 最新20件を逆順で表示

            tbody.innerHTML = recentData.map(item => {
                const date = new Date(item.date);
                const year = date.getFullYear();
                const week = Math.ceil((date - new Date(year, 0, 1)) / (7 * 24 * 60 * 60 * 1000));
                
                return `
                    <tr>
                        <td>${date.toLocaleDateString('ja-JP')}</td>
                        <td style="font-family: monospace; text-align: right;">${item.value}</td>
                        <td>${year}</td>
                        <td>${week}</td>
                    </tr>
                `;
            }).join('');
        }

        // ビューのレンダリング
        async function renderView(view) {
            const content = document.getElementById('main-content');
            
            switch (view) {
                case 'overview':
                    await renderOverview();
                    break;
                case 'diseases':
                    await renderDiseaseAnalysis();
                    break;
                case 'categories':
                    content.innerHTML = '<div class="loading">分類別統計機能は準備中です...</div>';
                    break;
                case 'trends':
                    content.innerHTML = '<div class="loading">時系列分析機能は準備中です...</div>';
                    break;
                case 'sentinel-overview':
                    await renderSentinelOverview();
                    break;
                case 'sentinel-diseases':
                    await renderSentinelDiseases();
                    break;
                case 'sentinel-geographic':
                    await renderSentinelGeographic();
                    break;
                default:
                    content.innerHTML = '<div class="error">不明なビューです</div>';
            }
        }

        // 定点サーベイランス概況ビュー
        async function renderSentinelOverview() {
            const content = document.getElementById('main-content');
            
            content.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card" style="background: linear-gradient(135deg, #059669, #047857);">
                        <div class="stat-label">定点医療機関数</div>
                        <div class="stat-value">約400</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #dc2626, #b91c1c);">
                        <div class="stat-label">監視対象疾患</div>
                        <div class="stat-value">28種類</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #7c3aed, #6d28d9);">
                        <div class="stat-label">データ期間</div>
                        <div class="stat-value">26年間</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #ea580c, #c2410c);">
                        <div class="stat-label">週次報告</div>
                        <div class="stat-value">1,352週</div>
                    </div>
                </div>
                
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-title">🤧 主要監視疾患の特徴</div>
                        <div style="padding: 1rem;">
                            <div style="display: grid; gap: 1rem;">
                                <div style="padding: 1rem; background: #fef3c7; border-radius: 0.5rem; border-left: 4px solid #f59e0b;">
                                    <div style="font-weight: 600; color: #92400e;">インフルエンザ</div>
                                    <div style="font-size: 0.875rem; color: #78350f; margin-top: 0.25rem;">冬季に流行する季節性感染症。定点サーベイランスの主要監視対象</div>
                                </div>
                                <div style="padding: 1rem; background: #dbeafe; border-radius: 0.5rem; border-left: 4px solid #3b82f6;">
                                    <div style="font-weight: 600; color: #1d4ed8;">感染性胃腸炎</div>
                                    <div style="font-size: 0.875rem; color: #1e40af; margin-top: 0.25rem;">年間を通じて発生。特に冬季にノロウイルスによる流行</div>
                                </div>
                                <div style="padding: 1rem; background: #dcfce7; border-radius: 0.5rem; border-left: 4px solid #22c55e;">
                                    <div style="font-weight: 600; color: #15803d;">RSウイルス感染症</div>
                                    <div style="font-size: 0.875rem; color: #166534; margin-top: 0.25rem;">乳幼児の重要な呼吸器感染症。秋冬季に流行</div>
                                </div>
                                <div style="padding: 1rem; background: #fce7f3; border-radius: 0.5rem; border-left: 4px solid #ec4899;">
                                    <div style="font-weight: 600; color: #be185d;">手足口病</div>
                                    <div style="font-size: 0.875rem; color: #9d174d; margin-top: 0.25rem;">夏季に流行する小児の感染症。エンテロウイルスが原因</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <div class="chart-title">📊 定点サーベイランスシステム</div>
                        <div style="padding: 1rem;">
                            <div style="display: grid; gap: 1rem;">
                                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #f9fafb; border-radius: 0.375rem;">
                                    <span style="font-weight: 500;">データ形式</span>
                                    <span>週次報告</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #f9fafb; border-radius: 0.375rem;">
                                    <span style="font-weight: 500;">報告分類</span>
                                    <span>性別・年齢別・地域別</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #f9fafb; border-radius: 0.375rem;">
                                    <span style="font-weight: 500;">対象期間</span>
                                    <span>2000年〜2025年</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #f9fafb; border-radius: 0.375rem;">
                                    <span style="font-weight: 500;">地理的範囲</span>
                                    <span>東京都全域</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-title">🗓️ 定点サーベイランス対象疾患一覧</div>
                    <div style="padding: 1rem;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                            <div>
                                <h4 style="margin-bottom: 0.75rem; color: #374151; font-weight: 600;">呼吸器感染症</h4>
                                <div style="font-size: 0.875rem; line-height: 1.5; color: #6b7280;">
                                    インフルエンザ、RSウイルス感染症、咽頭結膜熱、マイコプラズマ肺炎、クラミジア肺炎、百日咳
                                </div>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 0.75rem; color: #374151; font-weight: 600;">消化器感染症</h4>
                                <div style="font-size: 0.875rem; line-height: 1.5; color: #6b7280;">
                                    感染性胃腸炎、感染性胃腸炎（ロタウイルス）
                                </div>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 0.75rem; color: #374151; font-weight: 600;">小児感染症</h4>
                                <div style="font-size: 0.875rem; line-height: 1.5; color: #6b7280;">
                                    手足口病、水痘、ヘルパンギーナ、突発性発しん、川崎病、流行性耳下腺炎
                                </div>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 0.75rem; color: #374151; font-weight: 600;">その他</h4>
                                <div style="font-size: 0.875rem; line-height: 1.5; color: #6b7280;">
                                    麻しん、風しん、伝染性紅斑、急性出血性結膜炎、流行性角結膜炎、細菌性髄膜炎 他
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 定点サーベイランス 疾病分析ビュー
        async function renderSentinelDiseases() {
            const content = document.getElementById('main-content');
            
            try {
                // Sentinelデータの初期化（毎回最新データを読み込み）
                content.innerHTML = '<div class="loading">定点サーベイランスデータを読み込み中...</div>';
                await initializeSentinelData();

                content.innerHTML = `
                    <div class="filter-section">
                        <h3 class="chart-title">定点疾病分析設定</h3>
                        <div class="filter-grid">
                            <div class="form-group">
                                <label class="form-label">定点監視疾患</label>
                                <select id="sentinelDiseaseSelect" class="form-select">
                                    <option value="">疾患を選択してください</option>
                                    ${sentinelDiseaseList.map(disease => {
                                        const stats = sentinelSummaryData?.disease_statistics?.[disease];
                                        const totalCases = stats?.total_cases || 0;
                                        return `<option value="${disease}">${disease} (${totalCases.toLocaleString()}症例)</option>`;
                                    }).join('')}
                                </select>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                                    ※括弧内は全期間の累計症例数
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">開始年</label>
                                <select id="sentinelStartYear" class="form-select">
                                    ${Array.from({length: 26}, (_, i) => 2000 + i).map(year => `
                                        <option value="${year}" ${year === 2020 ? 'selected' : ''}>${year}年</option>
                                    `).join('')}
                                </select>
                                <div style="font-size: 0.75rem; color: transparent; margin-top: 0.25rem;">
                                    　
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">終了年</label>
                                <select id="sentinelEndYear" class="form-select">
                                    ${Array.from({length: 26}, (_, i) => 2000 + i).map(year => `
                                        <option value="${year}" ${year === 2024 ? 'selected' : ''}>${year}年</option>
                                    `).join('')}
                                </select>
                                <div style="font-size: 0.75rem; color: transparent; margin-top: 0.25rem;">
                                    　
                                </div>
                            </div>
                            <div class="form-group">
                                <button id="sentinelAnalyzeBtn" class="btn btn-primary" disabled>分析実行</button>
                                <div style="font-size: 0.75rem; color: transparent; margin-top: 0.25rem;">
                                    　
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="sentinelAnalysisResults" style="display: none;">
                        <div class="metric-cards">
                            <div class="metric-card">
                                <div class="metric-value" id="sentinelTotalRecords">-</div>
                                <div class="metric-label">週次報告数</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="sentinelTotalCases">-</div>
                                <div class="metric-label">期間内症例数</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="sentinelMaxWeekly">-</div>
                                <div class="metric-label">最大週間症例数</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="sentinelAvgWeekly">-</div>
                                <div class="metric-label">週平均症例数</div>
                            </div>
                        </div>
                        
                        <div class="charts-grid">
                            <div class="chart-card" style="grid-column: 1 / -1;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <div class="chart-title" id="sentinelTimeseriesTitle">定点疾病時系列グラフ</div>
                                    <div style="display: flex; gap: 1rem; align-items: center;">
                                        <div class="form-group" style="margin: 0;">
                                            <button id="sentinelSeasonalToggleBtn" class="btn btn-primary" style="font-size: 0.875rem; padding: 0.375rem 0.75rem;">
                                                季節性比較
                                            </button>
                                        </div>
                                        <div class="form-group" style="margin: 0;">
                                            <select id="sentinelTimeUnitSelect" class="form-select" style="min-width: 120px;">
                                                <option value="week">週単位</option>
                                                <option value="month">月単位</option>
                                                <option value="year">年単位</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="chart-container" style="height: 400px;">
                                    <canvas id="sentinelTimeseriesChart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <div class="chart-title">データ詳細 (最新20件)</div>
                            <div style="max-height: 400px; overflow-y: auto;">
                                <table class="data-table" id="sentinelDataTable">
                                    <thead>
                                        <tr>
                                            <th>週</th>
                                            <th>男性症例</th>
                                            <th>女性症例</th>
                                            <th>合計症例</th>
                                            <th>定点数</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sentinelDataTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;

                // イベントリスナーを追加
                setupSentinelDiseaseAnalysisEvents();

            } catch (error) {
                content.innerHTML = `<div class="error">定点疾病分析の読み込みに失敗しました: ${error.message}</div>`;
            }
        }

        // 定点疾病分析のイベントハンドラー
        function setupSentinelDiseaseAnalysisEvents() {
            const diseaseSelect = document.getElementById('sentinelDiseaseSelect');
            const analyzeBtn = document.getElementById('sentinelAnalyzeBtn');
            const seasonalToggleBtn = document.getElementById('sentinelSeasonalToggleBtn');
            const timeUnitSelect = document.getElementById('sentinelTimeUnitSelect');

            diseaseSelect.addEventListener('change', function() {
                analyzeBtn.disabled = !this.value;
            });

            analyzeBtn.addEventListener('click', async function() {
                const disease = diseaseSelect.value;
                const startYear = document.getElementById('sentinelStartYear').value;
                const endYear = document.getElementById('sentinelEndYear').value;

                if (!disease) return;

                this.disabled = true;
                this.textContent = '分析中...';

                try {
                    await analyzeSentinelDiseaseData(disease, startYear, endYear);
                } catch (error) {
                    alert('分析中にエラーが発生しました: ' + error.message);
                } finally {
                    this.disabled = false;
                    this.textContent = '分析実行';
                }
            });

            // 季節性比較ボタンのイベントリスナー
            seasonalToggleBtn.addEventListener('click', function() {
                if (!sentinelCurrentData) {
                    alert('まず疾病を選択して分析を実行してください');
                    return;
                }

                const disease = document.getElementById('sentinelDiseaseSelect').value;
                const startYear = document.getElementById('sentinelStartYear').value;
                const endYear = document.getElementById('sentinelEndYear').value;

                if (sentinelIsSeasonalMode) {
                    // 季節性比較モードから通常表示に戻る
                    sentinelIsSeasonalMode = false;
                    sentinelSeasonalData = null;
                    updateSentinelSeasonalToggleButton();
                    renderSentinelTimeseries(sentinelCurrentData, disease);
                } else {
                    // 通常表示から季節性比較モードに切り替え
                    if (parseInt(startYear) === parseInt(endYear)) {
                        // 同一年の場合は季節性比較を実行
                        analyzeSentinelSeasonalPattern(disease, startYear);
                    } else {
                        alert('季節性比較は開始年と終了年を同じ年に設定してください');
                    }
                }
            });

            // 横軸単位変更のイベントリスナー
            timeUnitSelect.addEventListener('change', function() {
                if (!sentinelCurrentData) return;

                const disease = document.getElementById('sentinelDiseaseSelect').value;
                
                if (sentinelIsSeasonalMode && sentinelSeasonalData) {
                    // 季節性比較モードの場合
                    renderSentinelSeasonalComparisonChart(
                        sentinelSeasonalData.normalizedData,
                        sentinelSeasonalData.disease,
                        sentinelSeasonalData.years,
                        sentinelSeasonalData.targetYear
                    );
                } else {
                    // 通常モードの場合
                    renderSentinelTimeseries(sentinelCurrentData, disease);
                }
            });
        }

        // 定点疾病データの分析実行
        async function analyzeSentinelDiseaseData(disease, startYear, endYear) {
            try {
                // データをフィルタリング
                let filteredData = sentinelDataset.filter(record => 
                    record.disease_name === disease &&
                    record.year >= parseInt(startYear) &&
                    record.year <= parseInt(endYear)
                );

                if (filteredData.length === 0) {
                    throw new Error('指定された条件のデータが見つかりません');
                }

                // 現在のデータを保存
                sentinelCurrentData = filteredData;
                sentinelIsSeasonalMode = false;
                sentinelSeasonalData = null;

                // 統計情報を計算
                const totalCases = filteredData.reduce((sum, item) => sum + item.total_count, 0);
                const maxWeekly = Math.max(...filteredData.map(item => item.total_count));
                const avgWeekly = totalCases / filteredData.length;

                // メトリクスカードを更新
                document.getElementById('sentinelTotalRecords').textContent = filteredData.length.toLocaleString();
                document.getElementById('sentinelTotalCases').textContent = totalCases.toLocaleString();
                document.getElementById('sentinelMaxWeekly').textContent = maxWeekly.toLocaleString();
                document.getElementById('sentinelAvgWeekly').textContent = avgWeekly.toFixed(1);

                // ボタンの状態を更新
                updateSentinelSeasonalToggleButton();

                // チャートを描画
                renderSentinelTimeseries(filteredData, disease);

                // データテーブルを更新
                updateSentinelDataTable(filteredData);

                // 結果セクションを表示
                document.getElementById('sentinelAnalysisResults').style.display = 'block';

            } catch (error) {
                throw new Error(`データの分析に失敗しました: ${error.message}`);
            }
        }

        // 定点疾病時系列チャートの描画
        function renderSentinelTimeseries(data, diseaseName) {
            const ctx = document.getElementById('sentinelTimeseriesChart');
            
            // 既存のチャートを破棄
            if (window.sentinelChart) {
                window.sentinelChart.destroy();
            }

            // タイトルを更新
            document.getElementById('sentinelTimeseriesTitle').textContent = `${diseaseName} の発生動向（定点サーベイランス）`;

            // データを時系列順にソート
            data.sort((a, b) => {
                if (a.year !== b.year) return a.year - b.year;
                return a.week - b.week;
            });

            // 横軸単位を取得
            const timeUnit = document.getElementById('sentinelTimeUnitSelect').value;
            
            // 単位に応じてデータを集約
            const { labels, values } = aggregateSentinelDataByTimeUnit(data, timeUnit);

            window.sentinelChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: diseaseName,
                        data: values,
                        borderColor: 'rgba(34, 197, 94, 1)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        tension: 0.1,
                        fill: true,
                        pointRadius: 2,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '週間症例数'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '報告週'
                            },
                            ticks: {
                                maxTicksLimit: 20
                            }
                        }
                    }
                }
            });
        }

        // 定点データテーブルの更新
        function updateSentinelDataTable(data) {
            const tbody = document.getElementById('sentinelDataTableBody');
            const recentData = data.slice(-20).reverse(); // 最新20件を逆順で表示

            tbody.innerHTML = recentData.map(item => {
                return `
                    <tr>
                        <td>${item.year}年第${item.week}週</td>
                        <td style="font-family: monospace; text-align: right;">${item.male_count}</td>
                        <td style="font-family: monospace; text-align: right;">${item.female_count}</td>
                        <td style="font-family: monospace; text-align: right; font-weight: 600;">${item.total_count}</td>
                        <td style="font-family: monospace; text-align: right;">${item.sentinel_points}</td>
                    </tr>
                `;
            }).join('');
        }

        // 定点疾病データの時間単位集約
        function aggregateSentinelDataByTimeUnit(data, timeUnit) {
            if (timeUnit === 'week') {
                // 週単位の場合はそのまま
                const labels = data.map(item => `${item.year}年第${item.week}週`);
                const values = data.map(item => item.total_count);
                return { labels, values };
            } else if (timeUnit === 'month') {
                // 月単位で集約
                const monthlyData = {};
                data.forEach(item => {
                    const weekDate = new Date(item.year, 0, (item.week - 1) * 7 + 1);
                    const monthKey = `${item.year}-${String(weekDate.getMonth() + 1).padStart(2, '0')}`;
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = 0;
                    }
                    monthlyData[monthKey] += item.total_count;
                });
                
                const labels = Object.keys(monthlyData).sort().map(key => {
                    const [year, month] = key.split('-');
                    return `${year}年${month}月`;
                });
                const values = Object.keys(monthlyData).sort().map(key => monthlyData[key]);
                return { labels, values };
            } else if (timeUnit === 'year') {
                // 年単位で集約
                const yearlyData = {};
                data.forEach(item => {
                    const yearKey = item.year;
                    if (!yearlyData[yearKey]) {
                        yearlyData[yearKey] = 0;
                    }
                    yearlyData[yearKey] += item.total_count;
                });
                
                const labels = Object.keys(yearlyData).sort().map(year => `${year}年`);
                const values = Object.keys(yearlyData).sort().map(year => yearlyData[year]);
                return { labels, values };
            }
        }

        // 定点疾病季節性パターン分析
        async function analyzeSentinelSeasonalPattern(disease, targetYear) {
            try {
                // 過去5年間のデータを取得
                const years = [];
                const currentYear = parseInt(targetYear);
                for (let i = 4; i >= 0; i--) {
                    years.push(currentYear - i);
                }

                // 各年のデータを取得
                const yearlyData = {};
                const allNormalizedData = [];

                for (const year of years) {
                    const yearData = sentinelDataset.filter(record => 
                        record.disease_name === disease && 
                        record.year === year
                    );

                    if (yearData.length > 0) {
                        // 週ごとに正規化（1-52週）
                        const weeklyData = new Array(52).fill(0);
                        yearData.forEach(record => {
                            if (record.week >= 1 && record.week <= 52) {
                                weeklyData[record.week - 1] = record.total_count;
                            }
                        });

                        yearlyData[year] = weeklyData;
                        allNormalizedData.push({
                            year: year,
                            data: weeklyData
                        });
                    }
                }

                // 季節性データを保存
                sentinelSeasonalData = {
                    disease: disease,
                    years: years,
                    targetYear: currentYear,
                    normalizedData: allNormalizedData
                };

                sentinelIsSeasonalMode = true;
                updateSentinelSeasonalToggleButton();

                // 季節性比較チャートを描画
                renderSentinelSeasonalComparisonChart(allNormalizedData, disease, years, currentYear);

            } catch (error) {
                alert('季節性分析でエラーが発生しました: ' + error.message);
            }
        }

        // 定点疾病季節性比較チャートの描画
        function renderSentinelSeasonalComparisonChart(normalizedData, diseaseName, years, targetYear) {
            const ctx = document.getElementById('sentinelTimeseriesChart');
            
            // 既存のチャートを破棄
            if (window.sentinelChart) {
                window.sentinelChart.destroy();
            }

            // タイトルを更新
            document.getElementById('sentinelTimeseriesTitle').textContent = `${diseaseName} の季節性比較（定点サーベイランス）`;

            // ラベルを準備（週番号）
            const labels = Array.from({length: 52}, (_, i) => `第${i + 1}週`);

            // 色のパレット
            const colors = [
                'rgba(59, 130, 246, 1)',   // 対象年（青）
                'rgba(34, 197, 94, 1)',    // 1年前（緑）
                'rgba(245, 158, 11, 1)',   // 2年前（オレンジ）
                'rgba(239, 68, 68, 1)',    // 3年前（赤）
                'rgba(147, 51, 234, 1)'    // 4年前（紫）
            ];

            // データセットを準備
            const datasets = normalizedData.map((yearData, index) => {
                const isTargetYear = yearData.year === targetYear;
                return {
                    label: `${yearData.year}年`,
                    data: yearData.data,
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length].replace('1)', '0.1)'),
                    tension: 0.1,
                    fill: false,
                    pointRadius: isTargetYear ? 3 : 2,
                    pointHoverRadius: isTargetYear ? 6 : 4,
                    borderWidth: isTargetYear ? 3 : 2
                };
            }).reverse(); // 対象年を左端に配置

            window.sentinelChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '週間症例数'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '週番号'
                            }
                        }
                    }
                }
            });
        }

        // 定点疾病季節性比較ボタンの状態更新
        function updateSentinelSeasonalToggleButton() {
            const toggleBtn = document.getElementById('sentinelSeasonalToggleBtn');
            if (sentinelIsSeasonalMode) {
                toggleBtn.textContent = '通常表示';
                toggleBtn.style.backgroundColor = '#dc2626';
            } else {
                toggleBtn.textContent = '季節性比較';
                toggleBtn.style.backgroundColor = '#3b82f6';
            }
        }

        // 定点サーベイランス 地域別分析ビュー
        async function renderSentinelGeographic() {
            const content = document.getElementById('main-content');
            
            content.innerHTML = `
                <div class="loading">地域別分析機能を実装中...</div>
                <div style="padding: 2rem; text-align: center; color: #6b7280;">
                    <div style="font-size: 1.125rem; margin-bottom: 1rem;">🗺️ 地域別疫学分析</div>
                    <div>保健所別・医療圏別データの地理的分析機能を準備中です</div>
                </div>
            `;
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            // Sentinelデータをクリア（最新データを確実に読み込むため）
            sentinelDataset = null;
            sentinelSummaryData = null;
            sentinelDiseaseList = [];
            
            // ナビゲーション処理
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    currentView = this.dataset.view;
                    renderView(currentView);
                });
            });
            
            renderView('overview');
        });
    </script>
</body>
</html>